<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebFlux Chat (SSE)</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #chat-box { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; white-space: pre-wrap; }
        #user-input { width: 80%; }
        #send-btn { padding: 5px 10px; }
        #status { color:#666; margin: 6px 0; }
    </style>
</head>
<body>
<h2>OpenAI 대화방</h2>
<div id="status">대기 중…</div>
<div id="chat-box"></div>
<br/>
<input type="text" id="user-input" placeholder="문의: " />
<button id="send-btn">전송</button>

<script>
    const button  = document.getElementById('send-btn');
    const input   = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');
    const status  = document.getElementById('status');

    let es = null; // 현재 진행중인 EventSource

    button.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

    function appendMessage(text) {
      chatBox.textContent += text;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function closeStream() {
      if (es) { es.close(); es = null; }
    }

    function sendMessage() {
      const query = input.value.trim();
      if (!query) return;

      // 이전 스트림이 남아있다면 정리
      closeStream();

      appendMessage(`\nYou: ${query}\nAI: `);
      input.value = '';

      // 동일 오리진 기준. 다른 도메인이면 CORS 설정 필요(@CrossOrigin 등)
      const url = `/chat?message=${encodeURIComponent(query)}`;

      // SSE 연결 시작
      es = new EventSource(url);

      es.onopen = () => {
        status.textContent = 'SSE 연결되었습니다';
      };

      // 서버가 기본 event 타입으로 보내는 경우
      es.onmessage = (evt) => {
        // Spring WebFlux가 Flux<String>을 TEXT_EVENT_STREAM으로 내보내면
        // evt.data가 한 토큰/한 줄씩 들어옵니다.
        appendMessage(evt.data);
      };

      es.onerror = () => {
        status.textContent = '연결 종료(정상 완료 또는 오류)';
        closeStream(); // 사용자 정의 정리 함수
      };
    }
</script>
</body>
</html>
